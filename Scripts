-- Comandos Utilizados

--Caminho do arquivo de Configuração da Instação
C:\Program Files\PostgreSQL\11\data\pg_hba.conf

--Verificar caminho de dos parâmetros de configuração da instação do banco
SELECT * FROM pg_config;

--Verificar informação dos Bancos
select * from pg_stat_database;

-- Criado um User com todos acessor - SuperUser / Para ser usado nos exemplos a seguir
CREATE ROLE "User_DEV" WITH
	LOGIN
	SUPERUSER
	CREATEDB
	CREATEROLE
	INHERIT
	REPLICATION
	CONNECTION LIMIT -1
	PASSWORD 'xxxxxx';
COMMENT ON ROLE "User_DEV" IS 'Usuário para Banco DEV';

-- Criado Uma TableSpace para ser armazenado apenas os Objetos do banco DEV e usuário anterior criado como proprietário.
CREATE TABLESPACE "pgTB_DEV"
  OWNER "User_DEV"
  LOCATION 'C:\TablespacePG_DEV';

ALTER TABLESPACE "pgTB_DEV"
  OWNER TO "User_DEV";

COMMENT ON TABLESPACE "pgTB_DEV"
  IS 'Tablespace para o Banco DEV';


-- Criado Banco DEV, proprietário User_DEV e Tablespace pgTB_DEV'
CREATE DATABASE "DEV"
    WITH 
    OWNER = "User_DEV"
    TEMPLATE = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'Portuguese_Brazil.1252'
    LC_CTYPE = 'Portuguese_Brazil.1252'
    TABLESPACE = "pgTB_DEV"
    CONNECTION LIMIT = -1;
COMMENT ON DATABASE "DEV"
    IS 'Banco DEV, proprietário User_DEV e Tablespace pgTB_DEV';

--Criado um Esquema Privado para o Banco DEV
CREATE SCHEMA dev
    AUTHORIZATION "User_DEV";
COMMENT ON SCHEMA dev
    IS 'Esquema privado para Objetos do Banco DEV';
    
-- Excluído o esquema publico do PostgreSQL da base DEV
DROP SCHEMA public ;

-- Criado Tabela com Primary Key, Default Salvo na TB - pgTB_DEV
CREATE TABLE dev."Produto"
(
    id_prod integer NOT NULL GENERATED ALWAYS AS IDENTITY,
    nm_prod character varying(100) NOT NULL,
    tp_prod integer NOT NULL,
    dt_cad_prod date NOT NULL CONSTRAINT DF_Produto_dt_cad_prod DEFAULT CURRENT_DATE,
    CONSTRAINT "id_prod" PRIMARY KEY (id_prod)
        USING INDEX TABLESPACE "pgTB_DEV"
)
WITH (
    OIDS = FALSE
)
TABLESPACE "pgTB_DEV";
ALTER TABLE dev."Produto"
    OWNER to "User_DEV";

--Excluir tabela Produto
DROP TABLE dev."Produto";

--Adicionando uma Constraint UNIQUE para o campo id_prod
ALTER TABLE dev."Produto"
    ADD CONSTRAINT "id_prod" UNIQUE (id_prod)
    USING INDEX TABLESPACE "pgTB_DEV";
    
-- Renomeando a constraint id_prod
ALTER TABLE dev."Produto"
    RENAME CONSTRAINT "IX_id_prod" TO "UNIQUE_id_prod";

-- Criado index Clustered, com algorito de Busca BTREE
CREATE INDEX ix_produto_id_prod
    ON dev."Produto" USING btree
    (id_prod ASC NULLS LAST)
    WITH (FILLFACTOR=97)
    TABLESPACE "pgTB_DEV";

ALTER TABLE dev."Produto"
    CLUSTER ON ix_produto_id_prod;

--Drop Index
DROP INDEX dev.ix_produto_id_prod;

-- Validando um Insert
insert into dev."Produto" (nm_prod, tp_prod) values ('FACA', 1);
explain select * from dev."Produto";

-- Criado Tabela Tipo Produto
CREATE TABLE dev."TipoProd" (
    id_tipoprod integer NOT NULL GENERATED ALWAYS AS IDENTITY,
    nm_tipo character varying(50) NOT NULL,
    dt_cad_tipo date NOT NULL CONSTRAINT DF_TipoProd_dt_cad_tipo DEFAULT CURRENT_DATE,
    CONSTRAINT "id_tipoprod" PRIMARY KEY (id_tipoprod)
        USING INDEX TABLESPACE "pgTB_DEV")
WITH ( OIDS = FALSE ) TABLESPACE "pgTB_DEV";
ALTER TABLE dev."Produto" OWNER to "User_DEV";

-- Adicionando 2 Tipos
insert into dev."TipoProd" (nm_tipo) values ('Alimentício');
insert into dev."TipoProd" (nm_tipo) values ('Utensílios de Cozinha');

-- Definindo campo tp_prod para aceitar NULL para poder criar uma FK
ALTER TABLE dev."Produto" ALTER COLUMN tp_prod DROP NOT NULL;

-- Criando uma FK na tabela Produto com o TipoProd
ALTER TABLE dev."Produto"
    ADD CONSTRAINT "FK_Produto_tp_prod_TipoProd_id_tipoprod" FOREIGN KEY (tp_prod)
    REFERENCES dev."TipoProd" (id_tipoprod) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;
COMMENT ON CONSTRAINT "FK_Produto_tp_prod_TipoProd_id_tipoprod" ON dev."Produto"
    IS 'FK tabela Produto com TIpoProd';

-- Renomeando nome FK
ALTER TABLE dev."Produto" RENAME CONSTRAINT "FK_Produto_id_prod_TipoProd_id_tipoprod" TO "FK_Produto_tp_prod_TipoProd_id_tipoprod";

-- Excluíndo FK
ALTER TABLE dev."Produto" DROP CONSTRAINT "FK_Produto_tp_prod_TipoProd_id_tipoprod";

-- Alterando a FK para Validate, devido ter sido criada NOT VALID
ALTER TABLE dev."Produto" VALIDATE CONSTRAINT "FK_Produto_tp_prod_TipoProd_id_tipoprod";

-- Alterando campo tp_prod para não aceitar null novamente
ALTER TABLE dev."Produto" ALTER COLUMN tp_prod SET NOT NULL;
